---
title: Password Storage
description: 
published: true
date: 2023-10-02T07:01:21.424Z
tags: security
editor: markdown
dateCreated: 2023-09-25T01:31:00.457Z
---

# Password Storage
- [ ] [後端基礎：資安細節隨手筆記](https://hugh-program-learning-diary-js.medium.com/%E5%BE%8C%E7%AB%AF%E5%9F%BA%E7%A4%8E-%E8%B3%87%E5%AE%89%E7%B4%B0%E7%AF%80%E9%9A%A8%E6%89%8B%E7%AD%86%E8%A8%98-deb1e6252944)
- [ ] [How Dropbox securely stores your passwords](https://dropbox.tech/security/how-dropbox-securely-stores-your-passwords)
- [ ] [Password Storage Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html)
- [ ] [聽說不能用明文存密碼，那到底該怎麼存？](https://medium.com/starbugs/how-to-store-password-in-database-sefely-6b20f48def92)
- [ ] [一次搞懂密碼學中的三兄弟 — Encode、Encrypt 跟 Hash](https://medium.com/starbugs/what-are-encoding-encrypt-and-hashing-4b03d40e7b0c)
- [ ] [[資訊安全] 密碼存明碼，怎麼不直接去裸奔算了？淺談 Hash , 用雜湊保護密碼](https://medium.com/@brad61517/%E8%B3%87%E8%A8%8A%E5%AE%89%E5%85%A8-%E5%AF%86%E7%A2%BC%E5%AD%98%E6%98%8E%E7%A2%BC-%E6%80%8E%E9%BA%BC%E4%B8%8D%E7%9B%B4%E6%8E%A5%E5%8E%BB%E8%A3%B8%E5%A5%94%E7%AE%97%E4%BA%86-%E6%B7%BA%E8%AB%87-hash-%E7%94%A8%E9%9B%9C%E6%B9%8A%E4%BF%9D%E8%AD%B7%E5%AF%86%E7%A2%BC-d561ad2a7d84)

# 密碼學
主要分成三個觀念：編碼（Encode）、加密（Encrypt）、雜湊（Hash）

# 編碼（Encode）
> - 只是換個方式表達資料
> - 不需要 Key 即可解碼（不安全）

首先來看看最簡單的編碼，所謂的編碼並不會修改資料、也沒有任何加密的效果，單純就是 **換個方式來表達資料** 而已，其中最有名的例子就是摩斯密碼

![編碼 摩斯密碼.png](http://192.168.25.60:8000/files/file_storage/41d6135f.png)

在摩斯密碼的編碼系統中，每個英文字母都可以被表示成點（`dot`）跟劃（`dash`）的組合，或是表示成長音跟短音，譬如說將 `Hello World` 編碼（encode）成摩斯密碼的形式就是 `.... . .-.. .-.. --- .-- --- .-. .-.. -..`

雖然這串東西乍看之下很難懂，但 只要知道摩斯密碼的轉換規則 就有辦法翻譯回來，所以編碼 完全沒有安全性可言，就只是 **換個方式來表達資料** 而已

## encodeURI（）、decodeURI（）
在 JavaScript 中有兩個很實用的 function 分別是 `encodeURI` 跟 `decodeURI`，他們是用來把網址中的特殊字元（空白、標點符號等等）編碼成符合 URL 的格式（轉完變超醜的）

譬如說 `https://www.google.com/search?q=創世神` 這段網址會被編碼成 `https://www.google.com/search?q=%E5%89%B5%E4%B8%96%E7%A5%9E` ，所以即便電腦不支援顯示中文，或是某些比較舊的瀏覽器無法貼中文網址，也還是可以透過編碼後的網址連到目標網站


## Base64
`Base64` 是一種可以把二進位的資料編碼成 `ASCII` 字元的方法

譬如說某使用者 `Larry` 的密碼是 `LarryIsSmart`，經過 `Base64` 編碼後變成 `TGFycnlJc1NtYXJ0Cg==`，所有使用者的密碼存在資料庫內就像這樣

![編碼 base64.png](http://192.168.25.60:8000/files/file_storage/f931e3aa.png)

雖然經過編碼後的字串 `TGFycnlJc1NtYXJ0Cg==` 在人類眼裡就像亂碼一樣，但他其實是不安全的。尤其經過 `Base64` 後的結果很常都是 `=` 或 `==` 結尾，所以如果有一天資料庫真的洩漏出去了，駭客也會在第一時間就發現可以用 `Base64` 解開，然後在很短的時間內得到原本的密碼

如果換個編碼方式呢，譬如說 `Base32`、`Base16` 或是 `UTF-7` 這些比較少人知道的編碼？

也不行，雖然這些編碼演算法比較少人在用，但頂多騙騙不懂電腦的路人甲乙。真正的駭客很可能會使用各種方法嘗試要 decode 密碼，所以不管用哪一種編碼都是不安全的，結論就是不要使用編碼來儲存密碼！

## Huffman Coding
霍夫曼編碼（Huffman Coding）是一種用來進行 無失真壓縮 的編碼演算法，說穿了他的概念就是把常用的字記成縮寫，從而降低資料量、達到壓縮的效果

如果還是覺得有點抽象的話，可以想想你去早餐店跟阿姨點餐時：`我要 “一個雞腿堡加蛋“ 跟 “大杯的冰紅茶”`

因為阿姨腦中有一個早餐縮寫的對照表，所以在你講的同時阿姨就會快速在紙上記下 `“G堡蛋、大冰紅”`，這就是壓縮技術的原理：把常出現的字用縮寫記錄下來，等日後要解壓縮時再還原回去

# 加密（Encrypt）
> - 用 Key 來保護資料的機密性
> - 加密跟解密都需要 Key

加密跟剛說到的編碼有點像，唯一不同之處是加密跟解密必須要有金鑰（Key）才能進行。以最簡單的 凱薩加密法 來說，他加密的方式就是把每個英文字母加上一個 偏移量，這個偏移量就是用來執行加解密的 Key

![加密 凱薩加密法.png](http://192.168.25.60:8000/files/file_storage/748e4da0.png)

假如我想要用凱薩加密法對 Hello World 進行加密，並且設定 key=3，那加密完的結果就會變成 Khoor Zruog，只有知道 key 的人才有辦法把 Khoor Zruoog 還原回去 Hello World

![加密 凱薩加密法 範例.png](http://192.168.25.60:8000/files/file_storage/1f7ca293.png)

說是這麼說，但你我都知道英文字母不就那 26 個嗎？照目前電腦的運算速度，只要把偏移量從 0 到 25 都算過一遍，即便我不知道 key 也可以很容易就看出偏移量是 3

所以說凱薩加密法非常不安全，他最大的用處應該就是在課堂上傳紙條，但又不想被中間的同學看懂，除此之外在現代已經沒什麼用處了

## AES
AES (Advanced Encryption Standard) 是一種對稱加密演算法，所謂的對稱就是說加密解密 都是用同一個 key，這點跟上面說到的凱薩加密法一樣，但 AES 不像凱薩的 key 只有 0–25 這麼少種，而是可以有超過 10³⁸ 種，所以安全性比凱薩高非常非常多

下圖三個 user 的密碼是以 `pa55w0rd` 為 key 進行 `AES256` 加密後的結果，即便資料庫洩露出去了，如果不知道 key 的話是不可能破解的，所以會比單純編碼還要安全

![加密 AES256.png](http://192.168.25.60:8000/files/file_storage/94bf1bda.png)

但因為使用者要登入時，後端必須確認使用者輸入的密碼加密後跟資料庫內的 password 是否符合，所以還是必須把 key 放在 server 上。既然是放在 server 上，那駭客就還是有機會拿到，你想想他都能偷到你家資料庫了，拿到加密用的 key 其實也不是太難的事情

而且這樣做還有另一個隱憂：因為公司內的員工可能會知道 key，所以就可以從資料庫得到使用者的密碼。如果你知道 Facebook 的工程師只要想要就能得到所有人的密碼，應該也不太放心吧，尤其很多人都在多個網站使用同樣的密碼

結論就是因為無法保證 key 的安全，所以不建議用加密的方式保存密碼

### 對稱式加密法的缺點

AES 又快又安全，聽起來超厲害對吧？但他這類 對稱式加密法 有一個缺點：就是如果你想把加密後的 文字/檔案 傳給你的秘密情人 Alice，兩個人就必須先講好密碼是什麼，這樣你傳過去她才用你設的密碼解密

但因為網路環境是不安全的（尤其是在有 HTTPS 之前），所以除非你把 Alice 當面約出來講密碼是什麼，不然只要是透過網路把密碼傳給對方，就有機會被中間人拿走

一旦中間人拿到密碼，那你用再強的加密演算法都沒有用。而且比起完全沒加密，更恐怖的是明明密碼已經被偷走了，你還自以為檔案有加密就超安全，真的怎麼死的都不知道

## RSA
為瞭解決上述的問題，於是就有了非對稱加密法，其中最有名的就是 RSA

RSA 這類非對稱加密法有個很特別的地方，就是他會產生一組兩個 Key 分別叫公鑰（Public Key）跟私鑰（Private Key），而且 用公鑰加密的內容只能用私鑰解（超神奇的！！！）

同樣的情況當你要傳檔案給 Alice，就先請 Alice 生一組 Key 然後把公鑰傳給你。你有了 Alice 產生的公鑰之後，就用公鑰幫檔案加密再傳給她，Alice 收到就可以用她自己手上的私鑰解開（這段比較難，可以多看幾遍）

安全性方面，因為私鑰從頭到尾都在 Alice 手上，完全沒有傳出去過，所以即便中間人取得公鑰加密後的檔案也沒辦法解開，超安全 der

# 雜湊（Hash）
> - 把資料丟進一串公式計算出一個結果
> - 無法反推回原字串

不知道大家有沒有注意過你的身份證字號，他的最後一碼其實是個驗證碼哦，他是前九碼根據 某個公式 計算出來的

以 M140051653 這個身份證字號來說，計算的方式是先把 M 轉換成對應的數字 21，接著根據下圖的方式進行計算，如果算出來剛好等於最後一碼，那代表這個身份證字號是合法的

![雜湊 範例 身份證字號.png](http://192.168.25.60:8000/files/file_storage/1a5d2d8d.png)

這種把各個 欄位/字元 丟進去某個公式計算的方式就叫做雜湊（Hash），而這個計算公式就稱為 雜湊函數（Hash function），過程可能會做各種加減乘除，最後算出一個值或字串

因為最後一個數字 3 是經由前幾個數字計算、濃縮出來的，所以理所當然不可能由雜湊後的結果 3 回推出前幾個數字分別是什麼，所以雜湊的過程是 不可逆的

## SHA1
雜湊是不可逆的，下圖三個密碼就是經過 `SHA1` 雜湊過的結果，像 Luka 的密碼 hash 過後是 `1785bf0ed0f6346210af2d64b310a99b4024ce44`，而這串東西無法經由運算反推回原密碼

![雜湊 SHA1.png](http://192.168.25.60:8000/files/file_storage/d884d6f3.png)

當使用者 Luka 要登入時，就把他輸入的密碼拿去經過 SHA1 雜湊，如果算出來的雜湊值跟資料庫內那一大串一樣，那就代表 Luka 有極高機率輸入了正確的密碼，所以就放行讓他登入

但可別忘記了，雖然雜湊值無法直接反推回原密碼，但你可以用電腦把長度為 8 的字串都用 SHA1 雜湊過一遍，譬如說從 00000000 一路算到 zzzzzzzz，然後建一個表

如下圖，因為 SHA1 的碰撞機率極低，如果計算的過程中找到某字串 hash 後剛好是 1785bf0ed0f6346210af2d64b310a99b4024ce44，那該字串 love1234 就非常有可能是 Luka 的密碼

![雜湊 碰撞攻擊.png](http://192.168.25.60:8000/files/file_storage/e26b727c.png)

雖然這聽起來很不可思議，真的要做也是一個大工程，但因為現在電腦的運算速度非常快，所以已經有人做過了。只要到 MD5Hashing.net 輸入你想要破解的雜湊值，甚至不需要告訴他是哪一種演算法，他就會幫你查表找出來，只要駭客拿到密碼雜湊值，就可以得到原本的密碼。

單純是把密碼進行雜湊也不夠安全了，因為大部分人使用的密碼都可以透過查表的方式快速破解

## 加鹽後用 SHA1 雜湊
答案是可以，這就是所謂的 加鹽（`Salt`）。如果今天有一個新的使用者要註冊，這時我們的後端系統就隨機生成一個長度十的字串稱作 `Salt`，計算 `Hash` 時就把使用者輸入的密碼跟 `Salt` 合在一起算

以下圖為例，小城 SmallTown 註冊時後端隨機生成的鹽是 `h7.@-]%<#L`，而他輸入的密碼是 `helloworld`，所以就計算 `SHA1("helloworld" + "h7.@-]%<#L")` 會得到 `f80533d9f6a59796080258d2d4a2e2ec548322d4`

![雜湊 加鹽後用 SHA1 雜湊.png](http://192.168.25.60:8000/files/file_storage/44ad1ccb.png)

因為 `salt` 會存在資料庫裡面，所以當有天小城要登入時，就把他輸入的密碼加上資料庫內的 `salt` 雜湊，看會不會得到相同的雜湊值，如果相同的話代表小城輸入的密碼是對的

安全性方面，因為那一大串 `f80533d...` 是 `helloworldh7.@-]%<#L` 經過 hash 後的結果，而 `helloworldh7.@-]%<#L` 本身也夠長夠亂，網路上的表根本不可能包含這個字串，所以把 `f80533d...` 那一大串丟到網站上也破解不出來，換句話說無法得知小城的密碼是 `helloworld`

但如果駭客真的拿到你家資料庫，代表他同時拿到每個人的 `salt` 和 `hash value`，雖然駭客無法像先前那樣直接查網路上的表，但他還是可以用自己的電腦算雜湊值，從 `aaaaaaaaaa` 到 `zzzzzzzzzz` 把每個字串都加上 `h7.@-]%<#L` 再做 hash 還是可以算出小城的密碼是 `helloworld`

雖然真的要算的話也是可以，但因為每個人的 `salt` 都不同，所以要把所有使用者的密碼都算出來的話可能需要租一台超級電腦來算。如果駭客得到使用者的密碼後無法獲得相對應的利益，那其實就是白花錢而已，所以很多駭客看到資料庫內的密碼有加鹽就會放棄了

換句話說，如果你是網站開發者，在儲存密碼時至少要加鹽再雜湊，而且隨機產生的 `salt` 盡量要含有特殊字元，這樣才能保證使用者的密碼安全

## Bcrypt
如果覺得上述的加鹽雜湊還是不夠安全的話，這邊還有另一種更安全的方法：就是把 `SHA1` 換成像 `Bcrypt` 這類的慢雜湊演算法。雖然 `Bcrypt` 的名字裡面有個 `crypt`，但他並不是加密法，而是跟 `SHA1` 一樣是雜湊演算法，唯一的差別是他計算很慢

計算慢有什麼好處呢？前面有提到 `SHA1` 的雜湊值之所以可以被查表查出來，就是因為現今的電腦計算太快了，就連建個表反查也不需要太多時間

而 `Bcrypt` 則是可以透過設定疊代次數讓他變慢，以疊代五次的 `Bcrypt` 來說，他的計算速度大概比 `SHA1` 慢 1000 倍。也就是說，假如你原本用 `SHA1` 計算三天就能反查出所有使用者的密碼，現在卻要花大概八年的時間才可以

下圖是使用者的密碼經過 `Bcrypt` 的結果，hash 出來總共有 60 個字元，很長很長

![雜湊 Bcrypt.png](http://192.168.25.60:8000/files/file_storage/9d5d3af9.png)

當使用者要登入、註冊時也是跟先前一樣的做法，就把密碼直接丟進去 `Bcrypt` 雜湊，雖然雜湊的過程會比 `SHA1` 慢一千倍，但整體而言單次雜湊還是非常快的，所以並不會有什麼問題

而且用 `Bcrypt` 還有另一個好處，因為以後電腦的運算速度還會更快，這時只要把疊代次數設定得更高就好了，疊代次數每增加 1 需要的時間就變兩倍，所以只要疊代次數一直加上去，就非常非常難被破解


# 三種演算法的比較
| 類型 | 不可逆演算法 | 對稱加密演算法 | 非對稱加密演算法 |
|---|:--:|:--:|:--:|
| 可逆性 | 不可逆 | 可逆 | 可逆 |
| 加密速度 | 快 | 快 | 慢 |
| 解密速度 | 快 | 快 | 慢 |
| 安全性 | 高 | 高 | 高 |
| 應用場景 | 密碼雜湊存儲 | 資料加密、檔案加密、磁碟加密 | 數位簽名、電子商務、身份驗證 |


[密碼加密 Mind](https://xmind.app/m/pE4BX4)



